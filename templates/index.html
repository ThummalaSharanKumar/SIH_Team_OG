<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentor's Eye | Student Success Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .sidebar-scrollbar::-webkit-scrollbar { width: 5px; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .filter-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-full md:w-1/3 max-w-md bg-white border-r border-slate-200 flex flex-col h-full">
        <div class="p-4 border-b border-slate-200">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="ph-duotone ph-binoculars text-blue-500 text-3xl"></i> Mentor's Eye</h1>
            <p class="text-sm text-slate-500">Holistic Student Success Platform</p>
        </div>
        
        <div class="p-4 space-y-3 border-b border-slate-200">
            <input type="text" id="searchInput" onkeyup="applyFilters()" placeholder="Search by name or ID..." class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="grid grid-cols-2 gap-2 text-sm">
                <select id="riskFilter" onchange="applyFilters()" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 filter-select">
                    <option value="all">All Risk Levels</option><option value="High">High Risk</option><option value="Medium">Medium Risk</option><option value="Low">Low Risk</option>
                </select>
                <select id="feeFilter" onchange="applyFilters()" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 filter-select">
                    <option value="all">All Fee Statuses</option><option value="Overdue">Overdue</option><option value="Due">Due</option><option value="Paid">Paid</option>
                </select>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto sidebar-scrollbar" id="studentListContainer">
             <div id="studentList">
                {% for student in student_data %}
                    {% set risk_level_map = {'Dropout': 'High', 'Enrolled': 'Medium', 'Graduate': 'Low'} %}
                    {% set display_risk = risk_level_map[student.risk.level] or 'Medium' %}

                    {% set risk_color_classes = {'High': 'border-red-500 bg-red-50', 'Medium': 'border-amber-400 bg-amber-50', 'Low': 'border-emerald-500 bg-emerald-50'} %}
                    {% set risk_text_color_classes = {'High': 'text-red-600', 'Medium': 'text-amber-600', 'Low': 'text-emerald-600'} %}
                    
                    <div class="student-card p-4 mx-2 my-1.5 border-l-4 {{ risk_color_classes[display_risk] }} rounded-r-lg cursor-pointer hover:shadow-md hover:border-blue-500 transition-all duration-200" 
                        onclick="showDetails('{{ student.StudentID }}')"
                        data-student-id="{{ student.StudentID }}" data-student-name="{{ student.Name }}" data-risk-level="{{ display_risk }}" data-fee-status="{{ student.FeeStatus }}">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-slate-800">{{ student.Name }}</p>
                                <p class="text-xs text-slate-500">{{ student.StudentID }}</p>
                            </div>
                             <div class="flex items-center gap-2 text-sm font-medium {{ risk_text_color_classes[display_risk] }}">
                                {{ display_risk }} Risk
                            </div>
                        </div>
                    </div>
                {% endfor %}
             </div>
             <p id="noResults" class="text-center text-slate-500 p-8 hidden">No students match the current filters.</p>
        </div>

        <!-- User Info and Logout Button -->
        <div class="p-4 border-t border-slate-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-slate-700">Logged in as:</p>
                    <p class="text-xs text-slate-500">{{ user_email }}</p>
                </div>
                <a href="/logout" class="px-3 py-1.5 text-xs font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">Logout</a>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 bg-slate-100 p-6 md:p-8 overflow-y-auto">
        <div id="welcomeView" class="flex flex-col items-center justify-center h-full text-center">
             <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm"><i class="ph-duotone ph-student text-5xl text-blue-500"></i></div>
            <h2 class="text-2xl font-bold text-slate-700">Welcome, Mentor!</h2>
            <p class="text-slate-500 mt-2 max-w-md">Select a student to view their holistic profile, including academic, behavioral, and wellness indicators.</p>
        </div>
        <div id="detailView" class="hidden fade-in"></div>
    </main>

    <script>
        const detailViewEl = document.getElementById('detailView');
        const welcomeViewEl = document.getElementById('welcomeView');
        let activeLineChart = null; 
        let currentStudentData = null;

        const RISK_LEVEL_MAP = {
            'Dropout': 'High',
            'Enrolled': 'Medium',
            'Graduate': 'Low'
        };
        
        function applyFilters() {
            const searchText = document.getElementById('searchInput').value.toUpperCase();
            const riskFilter = document.getElementById('riskFilter').value;
            const feeFilter = document.getElementById('feeFilter').value;
            
            const studentCards = document.querySelectorAll('.student-card');
            let visibleCount = 0;

            studentCards.forEach(card => {
                const studentId = card.dataset.studentId.toUpperCase();
                const studentName = card.dataset.studentName.toUpperCase();
                const riskLevel = card.dataset.riskLevel;
                const feeStatus = card.dataset.feeStatus;

                const searchMatch = studentId.includes(searchText) || studentName.includes(searchText);
                const riskMatch = (riskFilter === 'all' || riskLevel === riskFilter);
                const feeMatch = (feeFilter === 'all' || feeStatus === feeFilter);

                if (searchMatch && riskMatch && feeMatch) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            document.getElementById('noResults').style.display = visibleCount === 0 ? 'block' : 'none';
        }

        async function showDetails(studentID) {
            document.querySelectorAll('.student-card').forEach(card => card.classList.remove('bg-blue-100', 'border-blue-500', 'shadow-lg'));
            document.querySelector(`[data-student-id="${studentID}"]`)?.classList.add('bg-blue-100', 'border-blue-500', 'shadow-lg');
            
            welcomeViewEl.classList.add('hidden');
            detailViewEl.classList.remove('hidden');
            detailViewEl.innerHTML = `<div class="text-center p-10 text-slate-500">Loading holistic student profile...</div>`;

            try {
                const response = await fetch(`/student/${studentID}`);
                if (!response.ok) throw new Error('Could not fetch student data.');
                const data = await response.json();
                currentStudentData = data;
                renderDetailView(data);
                loadAndRenderNotes(studentID);
            } catch (error) {
                detailViewEl.innerHTML = `<div class="text-center p-10 text-red-500">Error: ${error.message}</div>`;
            }
        }

        function renderDetailView(data) {
            const { risk, history } = data;
            const displayRisk = RISK_LEVEL_MAP[risk.level] || 'Medium';
            const studentFirstName = data.Name.split(' ')[0];

            // --- UPGRADED: Mailto Templates ---
            const mailtoTemplates = {
                'Low Attendance': {
                    subject: "Checking In: Attendance and Support",
                    body: `Hi ${studentFirstName},\n\nI noticed your attendance has been a bit low recently, and I wanted to reach out to see if everything is okay. Sometimes things outside of class can get in the way, and we have resources to help.\n\nLet me know if you'd be open to a quick chat sometime.\n\nBest,\nYour Mentor`
                },
                'Low Average Score': {
                    subject: "Support for Your Classes",
                    body: `Hi ${studentFirstName},\n\nI'm checking in on how your classes are going this semester. I saw that your scores are a bit lower than expected, and I want to make sure you have all the support you need. The university offers excellent free tutoring services that many students find helpful.\n\nWould you be interested in exploring some of these options?\n\nBest regards,\nYour Mentor`
                },
                'Overdue Fees': {
                    subject: "Confidential: Financial Support and Resources",
                    body: `Hi ${studentFirstName},\n\nThis is a confidential note to let you know that if you are facing challenges with tuition fees, the university has support systems in place, including payment plans and financial aid counseling. This is a common issue, and the financial aid office is here to help.\n\nPlease let me know if I can help connect you.\n\nSincerely,\nYour Mentor`
                },
                'High Financial Stress': {
                    subject: "Confidential Support: Financial Wellness Resources",
                    body: `Hi ${studentFirstName},\n\nI'm reaching out because the university has a number of confidential financial wellness resources, including emergency funds and counseling, available to students who might be feeling financial pressure.\n\nIf you're interested, I can help connect you with the right office. Your well-being is our top priority.\n\nBest regards,\nYour Mentor`
                },
                'Health Issues Impacting Study': {
                    subject: "Support for Your Health and Studies",
                    body: `Hi ${studentFirstName},\n\nI hope you're doing okay. I'm reaching out to remind you that Student Health Services and academic concession options are available if health challenges are impacting your studies. Your health comes first, and the university is here to support you.\n\nPlease don't hesitate to reach out if you need help navigating these resources.\n\nSincerely,\nYour Mentor`
                },
                'Low Career Confidence': {
                    subject: "Thinking About the Future? Let's Chat!",
                    body: `Hi ${studentFirstName},\n\nIt's completely normal for students to question if their major aligns with their future goals. I wanted to let you know that our Career Counseling services are fantastic for exploring different paths and finding what truly excites you.\n\nIf you're feeling unsure about your career path, I'd be happy to help you schedule a meeting with a counselor.\n\nBest,\nYour Mentor`
                }
            };

            const playbookActions = {
                'Low Attendance': { text: 'Send Attendance Reminder', icon: 'ph-calendar-x' },
                'Low Average Score': { text: 'Schedule Tutoring Session', icon: 'ph-books' },
                'Overdue Fees': { text: 'Share Financial Aid Info', icon: 'ph-currency-dollar-simple' },
                'High Financial Stress': { text: 'Connect with Financial Aid Office', icon: 'ph-currency-dollar-simple' },
                'Health Issues Impacting Study': { text: 'Share Student Health Services Info', icon: 'ph-first-aid-kit' },
                'Low Career Confidence': { text: 'Schedule Career Counseling Meeting', icon: 'ph-briefcase' },
            };

            let playbookHTML = `<p class="text-slate-500 text-sm">No intervention required at this time.</p>`;
            if (risk.factors && risk.factors.length > 0) {
                playbookHTML = risk.factors.map(factor => {
                    const action = playbookActions[factor.text];
                    const template = mailtoTemplates[factor.text];
                    if (!action || !template) return '';
                    
                    const mailtoLink = `mailto:${data.Email}?subject=${encodeURIComponent(template.subject)}&body=${encodeURIComponent(template.body)}`;
                    return `<a href="${mailtoLink}" target="_blank" class="w-full text-left flex items-center gap-3 p-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors border border-blue-200"><i class="ph ${action.icon} text-xl text-blue-600"></i><div><p class="font-semibold text-blue-800">${action.text}</p></div></a>`;
                }).join('');
            }
            
            let summaryText = `This student is currently classified with <strong>${displayRisk} Risk</strong>. `;
            if (risk.factors && risk.factors.length > 0) {
                const factorTexts = risk.factors.map(f => f.text.toLowerCase());
                summaryText += `The primary contributing factors appear to be ${factorTexts.join(', ')}.`;
            } else {
                summaryText += "They appear to be on track with no significant risk factors.";
            }

            const riskColorClasses = {
                'High': 'bg-red-100 text-red-800', 
                'Medium': 'bg-amber-100 text-amber-800', 
                'Low': 'bg-emerald-100 text-emerald-800'
            };
            const riskColorClass = riskColorClasses[displayRisk];
            
            detailViewEl.innerHTML = `
                <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">${data.Name}</h2>
                        <p class="text-slate-500 text-sm">${data.StudentID} | ${data.Branch} | Year ${data.Year}</p>
                        <!-- CORRECTED: Added the email and phone number back -->
                        <p class="text-slate-500 flex items-center gap-2 text-sm mt-1"><i class="ph ph-envelope-simple"></i> ${data.Email || 'N/A'} <i class="ph ph-phone ml-2"></i> ${data.Phone || 'N/A'}</p>
                    </div>
                    <div class="px-4 py-2 rounded-full font-semibold text-sm ${riskColorClass}">${displayRisk} Risk</div>
                </div>
                
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-6">
                     <h3 class="text-lg font-semibold text-slate-700 mb-2 flex items-center gap-2"><i class="ph-duotone ph-info"></i> AI Summary</h3>
                     <p class="text-slate-600">${summaryText}</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Academic Profile -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4">Academic Profile</h3>
                        <div class="space-y-4 text-sm">
                            <div class="flex items-center justify-between"><p class="text-slate-600">Attendance</p><p class="font-bold text-lg ${data.AttendancePercentage < 75 ? 'text-red-600' : 'text-slate-800'}">${data.AttendancePercentage}%</p></div>
                            <div class="flex items-center justify-between"><p class="text-slate-600">Average Score</p><p class="font-bold text-lg ${data.AverageScore < 60 ? 'text-red-600' : 'text-slate-800'}">${data.AverageScore}</p></div>
                             <div class="flex items-center justify-between"><p class="text-slate-600">Fee Status</p><p class="font-semibold text-xs px-2 py-1 rounded ${data.FeeStatus === 'Overdue' ? 'bg-red-100 text-red-700' : data.FeeStatus === 'Due' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">${data.FeeStatus}</p></div>
                        </div>
                    </div>
                    <!-- Wellness Profile -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4">Wellness Profile</h3>
                        <div class="space-y-4 text-sm">
                             <div class="flex items-center justify-between"><p class="text-slate-600">Financial Stress</p><p class="font-bold text-lg ${data.FinancialStressScore >= 4 ? 'text-red-600' : 'text-slate-800'}">${data.FinancialStressScore} / 5</p></div>
                             <div class="flex items-center justify-between"><p class="text-slate-600">Career Confidence</p><p class="font-bold text-lg ${data.CareerConfidenceScore <= 2 ? 'text-red-600' : 'text-slate-800'}">${data.CareerConfidenceScore} / 5</p></div>
                             <div class="flex items-center justify-between"><p class="text-slate-600">Health Impact</p><p class="font-bold text-lg ${data.HealthImpact === 'Yes' ? 'text-red-600' : 'text-slate-800'}">${data.HealthImpact}</p></div>
                        </div>
                    </div>
                    <!-- Intervention Playbook -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4">Intervention Playbook</h3>
                        <div class="space-y-2">${playbookHTML}</div>
                    </div>
                    <!-- Performance Trends Chart -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm lg:col-span-3">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2"><i class="ph-duotone ph-chart-line"></i> Performance Trends</h3>
                        <div class="h-64"><canvas id="trendChart"></canvas></div>
                    </div>
                    <!-- Mentor Log -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm lg:col-span-3">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2"><i class="ph-duotone ph-notebook"></i> Mentor Log</h3>
                        <div class="space-y-3 mb-4">
                            <textarea id="noteText" class="w-full p-2 text-sm border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Log an interaction..."></textarea>
                            <button onclick="addNote()" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold text-sm rounded-md hover:bg-blue-700 transition-colors">Add Note</button>
                        </div>
                        <div id="notesList" class="space-y-3 max-h-64 overflow-y-auto pr-2 sidebar-scrollbar"></div>
                    </div>
                </div>`;

            renderCharts(data);
        }

        function renderCharts(data) {
            const { history } = data;
            if (activeLineChart) activeLineChart.destroy();
            const trendCtx = document.getElementById('trendChart')?.getContext('2d');
            if (!trendCtx) return;

            const labels = history.map(h => `Period ${h.ReportingPeriod}`);
            const attendanceData = history.map(h => h.AttendancePercentage);
            const scoreData = history.map(h => h.AverageScore);

            activeLineChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Attendance %', data: attendanceData, borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3 },
                        { label: 'Average Score', data: scoreData, borderColor: 'rgb(234, 179, 8)', backgroundColor: 'rgba(234, 179, 8, 0.1)', fill: true, tension: 0.3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, suggestedMin: 40, suggestedMax: 100 } }, plugins: { legend: { position: 'bottom' } } }
            });
        }
        
        async function loadAndRenderNotes(studentID) {
            const notesListEl = document.getElementById('notesList');
            try {
                const response = await fetch(`/get_notes/${studentID}`);
                const notes = await response.json();
                if (notes.error) throw new Error(notes.error);
                if (notes.length === 0) {
                    notesListEl.innerHTML = '<p class="text-slate-400 text-sm text-center py-4">No notes logged for this student yet.</p>';
                    return;
                }
                notesListEl.innerHTML = notes.map(note => {
                    const timestamp = new Date(note.timestamp).toLocaleString();
                    return `<div class="text-sm p-3 bg-slate-50 rounded-lg border border-slate-200"><p class="text-slate-700">${note.note_text}</p><p class="text-xs text-slate-400 mt-2 text-right">${note.mentor_name} on ${timestamp}</p></div>`;
                }).join('');
            } catch (error) {
                notesListEl.innerHTML = `<p class="text-red-500 text-sm">Could not load notes. ${error.message}</p>`;
            }
        }

        async function addNote() {
            const noteTextEl = document.getElementById('noteText');
            const noteText = noteTextEl.value.trim();
            if (!noteText || !currentStudentData) return;
            try {
                const response = await fetch('/add_note', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: currentStudentData.StudentID, note_text: noteText, mentor_name: '{{ user_email }}' })
                });
                const result = await response.json();
                if (result.success) {
                    noteTextEl.value = '';
                    loadAndRenderNotes(currentStudentData.StudentID);
                } else { throw new Error(result.error || 'Failed to add note.'); }
            } catch (error) { alert(`Error: ${error.message}`); }
        }
    </script>
</body>
</html>

