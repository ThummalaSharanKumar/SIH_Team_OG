<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentor's Eye | Student Success Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .sidebar-scrollbar::-webkit-scrollbar { width: 5px; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .filter-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
        input[type="range"] { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; width: 100%; }
        input[type="range"]::-webkit-slider-runnable-track { background: #e2e8f0; height: 0.25rem; border-radius: 0.25rem; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -6px; background-color: #3b82f6; height: 1.25rem; width: 1.25rem; border-radius: 50%; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-full md:w-1/3 max-w-md bg-white border-r border-slate-200 flex flex-col h-full">
        <div class="p-4 border-b border-slate-200">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="ph-duotone ph-binoculars text-blue-500 text-3xl"></i> Mentor's Eye</h1>
            <p class="text-sm text-slate-500">AI-Powered Student Monitoring</p>
        </div>
        
        <div class="p-4 space-y-3 border-b border-slate-200">
            <input type="text" id="searchInput" onkeyup="applyFilters()" placeholder="Search students by ID..." class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="grid grid-cols-2 gap-2 text-sm">
                <select id="riskFilter" onchange="applyFilters()" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 filter-select">
                    <option value="all">All Risk Levels</option><option value="High">High Risk</option><option value="Medium">Medium Risk</option><option value="Low">Low Risk</option>
                </select>
                <select id="feeFilter" onchange="applyFilters()" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 filter-select">
                    <option value="all">All Fee Statuses</option><option value="Overdue">Overdue</option><option value="Due">Due</option><option value="Paid">Paid</option>
                </select>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto sidebar-scrollbar" id="studentListContainer">
             <div id="studentList">
                {% for student in student_data %}
                    {% set risk = student.risk %}
                    {% set risk_color_classes = {'High': 'border-red-500 bg-red-50', 'Medium': 'border-amber-400 bg-amber-50', 'Low': 'border-emerald-500 bg-emerald-50'} %}
                    {% set risk_text_color_classes = {'High': 'text-red-600', 'Medium': 'text-amber-600', 'Low': 'text-emerald-600'} %}
                    
                    <div class="student-card p-4 mx-2 my-1.5 border-l-4 {{ risk_color_classes[risk.level] }} rounded-r-lg cursor-pointer hover:shadow-md hover:border-blue-500 transition-all duration-200" 
                        onclick="showDetails('{{ student.StudentID }}')"
                        data-student-id="{{ student.StudentID }}" data-risk-level="{{ risk.level }}" data-fee-status="{{ student.FeeStatus }}">
                        <div class="flex justify-between items-center"><p class="font-semibold text-slate-800">{{ student.StudentID }}</p><div class="flex items-center gap-2 text-sm font-medium {{ risk_text_color_classes[risk.level] }}">{{ risk.level }} Risk</div></div>
                    </div>
                {% endfor %}
             </div>
             <p id="noResults" class="text-center text-slate-500 p-8 hidden">No students match the current filters.</p>
        </div>

        <!-- User Info and Logout Button -->
        <div class="p-4 border-t border-slate-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-slate-700">Logged in as:</p>
                    <p class="text-xs text-slate-500">{{ user_email }}</p>
                </div>
                <a href="/logout" class="px-3 py-1.5 text-xs font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">Logout</a>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 bg-slate-100 p-6 md:p-8 overflow-y-auto">
        <div id="welcomeView" class="flex flex-col items-center justify-center h-full text-center">
             <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm"><i class="ph-duotone ph-notebook text-5xl text-blue-500"></i></div>
            <h2 class="text-2xl font-bold text-slate-700">Welcome, Mentor!</h2>
            <p class="text-slate-500 mt-2 max-w-md">Select a student to view their AI analysis, performance trends, and log your interactions.</p>
        </div>
        <div id="detailView" class="hidden fade-in"></div>
    </main>

    <script>
        const detailViewEl = document.getElementById('detailView');
        const welcomeViewEl = document.getElementById('welcomeView');
        let activeDoughnutChart = null;
        let activeLineChart = null; 
        let currentStudentData = null;

        function applyFilters() {
            const searchText = document.getElementById('searchInput').value.toUpperCase();
            const riskFilter = document.getElementById('riskFilter').value;
            const feeFilter = document.getElementById('feeFilter').value;
            
            const studentCards = document.querySelectorAll('.student-card');
            let visibleCount = 0;

            studentCards.forEach(card => {
                const studentId = card.dataset.studentId.toUpperCase();
                const riskLevel = card.dataset.riskLevel;
                const feeStatus = card.dataset.feeStatus;

                const searchMatch = studentId.includes(searchText);
                const riskMatch = (riskFilter === 'all' || riskLevel === riskFilter);
                const feeMatch = (feeFilter === 'all' || feeStatus === feeFilter);

                if (searchMatch && riskMatch && feeMatch) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            document.getElementById('noResults').style.display = visibleCount === 0 ? 'block' : 'none';
        }

        async function showDetails(studentID) {
            document.querySelectorAll('.student-card').forEach(card => card.classList.remove('bg-blue-100', 'border-blue-500', 'shadow-lg'));
            document.querySelector(`[data-student-id="${studentID}"]`)?.classList.add('bg-blue-100', 'border-blue-500', 'shadow-lg');
            
            welcomeViewEl.classList.add('hidden');
            detailViewEl.classList.remove('hidden');
            detailViewEl.innerHTML = `<div class="text-center p-10 text-slate-500">Loading profile and mentor log...</div>`;

            try {
                const response = await fetch(`/student/${studentID}`);
                if (!response.ok) throw new Error('Could not fetch student data.');
                const data = await response.json();
                currentStudentData = data;
                renderDetailView(data);
                loadAndRenderNotes(studentID);
            } catch (error) {
                detailViewEl.innerHTML = `<div class="text-center p-10 text-red-500">Error: ${error.message}</div>`;
            }
        }

        function renderDetailView(data) {
            const { risk, history } = data;
            const gradeVelocity = data.AverageScore - data.MidtermGrade;
            
            const emailSubject = "Checking In - Academic Support";
            const emailBody = `Hi ${data.StudentID},\n\nI'm reaching out to check in on how your semester is going. I'm here to support you, and there are many resources available at the institution to help you succeed.\n\nWould you be open to a brief chat sometime this week to discuss how things are going for you?\n\nBest regards,\nYour Mentor`;
            const mailtoLink = `mailto:${data.Email}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            
            // --- NEW: Dynamic Playbook Logic ---
            const playbookActions = {
                'Low Attendance': { text: 'Send Attendance Reminder', icon: 'ph-calendar-x' },
                'Low Average Score': { text: 'Schedule Tutoring Session', icon: 'ph-books' },
                'Overdue Fees': { text: 'Share Financial Aid Info', icon: 'ph-currency-dollar-simple' },
                'Declining Grades': { text: 'Suggest a Peer Mentor', icon: 'ph-users-three' }
            };

            let playbookHTML = `<p class="text-slate-500 text-sm">No immediate intervention required.</p>`;
            if (risk.factors && risk.factors.length > 0) {
                playbookHTML = risk.factors.map(factor => {
                    const action = playbookActions[factor.text];
                    if (!action) return '';
                    return `<a href="${mailtoLink}" class="w-full text-left flex items-center gap-3 p-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors border border-blue-200"><i class="ph ${action.icon} text-xl text-blue-600"></i><div><p class="font-semibold text-blue-800">${action.text}</p></div></a>`;
                }).join('');
            }
            
            // --- NEW: Natural Language Summary ---
            let summaryText = `This student is currently classified with <strong>${risk.level} Risk</strong>. `;
            if (risk.factors && risk.factors.length > 0) {
                const factorTexts = risk.factors.map(f => f.text.toLowerCase());
                summaryText += `The primary contributing factors are ${factorTexts.join(' and ')}.`;
            } else {
                summaryText += "They appear to be on track with no significant risk factors.";
            }

            const riskColorClass = risk.level === 'High' ? 'bg-red-100 text-red-800' : risk.level === 'Medium' ? 'bg-amber-100 text-amber-800' : 'bg-emerald-100 text-emerald-800';

            const whatIfHTML = `...`; // Unchanged, redacted for brevity
            const mentorLogHTML = `...`; // Unchanged, redacted for brevity
            
            detailViewEl.innerHTML = `
                <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
                    <div><h2 class="text-2xl font-bold text-slate-800">${data.StudentID}</h2><p class="text-slate-500 flex items-center gap-2 text-sm"><i class="ph ph-envelope-simple"></i> ${data.Email} <i class="ph ph-phone ml-2"></i> ${data.Phone}</p></div>
                    <div class="px-4 py-2 rounded-full font-semibold text-sm ${riskColorClass}">${risk.level} Risk</div>
                </div>
                
                <!-- NEW: Natural Language Summary Card -->
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-6">
                     <h3 class="text-lg font-semibold text-slate-700 mb-2 flex items-center gap-2"><i class="ph-duotone ph-info"></i> AI Summary</h3>
                     <p class="text-slate-600">${summaryText}</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm lg:col-span-3"><h3 class="text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2"><i class="ph-duotone ph-chart-line"></i> Performance Trends</h3><div class="h-64"><canvas id="trendChart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><h3 class="text-lg font-semibold text-slate-700 mb-4">Current Indicators</h3><div class="space-y-4 text-sm"><div class="flex items-center justify-between"><p class="text-slate-600">Attendance</p><p class="font-bold text-lg ${data.AttendancePercentage < 75 ? 'text-red-600' : 'text-slate-800'}">${data.AttendancePercentage}%</p></div><div class="flex items-center justify-between"><p class="text-slate-600">Average Score</p><p class="font-bold text-lg ${data.AverageScore < 60 ? 'text-red-600' : 'text-slate-800'}">${data.AverageScore}</p></div><div class="flex items-center justify-between"><p class="text-slate-600">Grade Velocity</p><p class="font-bold text-lg ${gradeVelocity < 0 ? 'text-red-600' : 'text-emerald-600'}">${gradeVelocity.toFixed(1)}</p></div></div></div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><h3 class="text-lg font-semibold text-slate-700 mb-4">Prediction Probabilities</h3><canvas id="probabilityChart"></canvas></div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><h3 class="text-lg font-semibold text-slate-700 mb-4">Intervention Playbook</h3><div class="space-y-2">${playbookHTML}</div></div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm lg:col-span-3">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2"><i class="ph-duotone ph-arrows-clockwise"></i> What-If Scenario Analysis</h3>
                    <div class="space-y-4 text-sm">
                        <div>
                            <label for="attendanceSlider" class="block text-slate-600 mb-1">Adjust Attendance %</label>
                            <div class="flex items-center gap-3">
                                <input type="range" id="attendanceSlider" min="40" max="100" value="${data.AttendancePercentage}" class="w-full" oninput="updateSliderValue(this.value, 'attendanceValue'); recalculateRisk();">
                                <span id="attendanceValue" class="font-bold text-slate-700 w-12 text-center">${data.AttendancePercentage}%</span>
                            </div>
                        </div>
                        <div>
                            <label for="scoreSlider" class="block text-slate-600 mb-1">Adjust Average Score</label>
                             <div class="flex items-center gap-3">
                                <input type="range" id="scoreSlider" min="30" max="100" value="${data.AverageScore}" class="w-full" oninput="updateSliderValue(this.value, 'scoreValue'); recalculateRisk();">
                                <span id="scoreValue" class="font-bold text-slate-700 w-12 text-center">${data.AverageScore}</span>
                            </div>
                        </div>
                        <div class="pt-4 text-center bg-slate-50 rounded-lg p-3">
                            <p class="text-slate-600">New Predicted Risk:</p>
                            <p id="newRiskLevel" class="font-bold text-xl mt-1 text-slate-800 transition-all">${risk.level}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm lg:col-span-3">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2"><i class="ph-duotone ph-notebook"></i> Mentor Log</h3>
                    <div class="space-y-3 mb-4">
                        <textarea id="noteText" class="w-full p-2 text-sm border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Log an interaction, observation, or next step..."></textarea>
                        <button onclick="addNote()" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold text-sm rounded-md hover:bg-blue-700 transition-colors">Add Note</button>
                    </div>
                    <div id="notesList" class="space-y-3 max-h-64 overflow-y-auto pr-2 sidebar-scrollbar">
                        <p class="text-slate-400 text-sm">Loading notes...</p>
                    </div>
                </div>`;

            if (activeDoughnutChart) activeDoughnutChart.destroy();
            const probCtx = document.getElementById('probabilityChart').getContext('2d');
            activeDoughnutChart = new Chart(probCtx, { type: 'doughnut', data: { labels: Object.keys(risk.probabilities), datasets: [{ data: Object.values(risk.probabilities), backgroundColor: ['rgba(239, 68, 68, 0.8)', 'rgba(34, 197, 94, 0.8)', 'rgba(245, 158, 11, 0.8)'], borderColor: '#fff', borderWidth: 3 }] }, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
            
            if (activeLineChart) activeLineChart.destroy();
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            const labels = history.map(h => `Period ${h.ReportingPeriod}`);
            const attendanceData = history.map(h => h.AttendancePercentage);
            const scoreData = history.map(h => h.AverageScore);
            activeLineChart = new Chart(trendCtx, { type: 'line', data: { labels: labels, datasets: [ { label: 'Attendance %', data: attendanceData, borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3, yAxisID: 'y' }, { label: 'Average Score', data: scoreData, borderColor: 'rgb(234, 179, 8)', backgroundColor: 'rgba(234, 179, 8, 0.1)', fill: true, tension: 0.3, yAxisID: 'y' } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, suggestedMin: 40, suggestedMax: 100 } }, plugins: { legend: { position: 'bottom' } } } });
        }

        function updateSliderValue(value, elementId) {
            document.getElementById(elementId).textContent = elementId.includes('Value') ? `${value}${elementId.includes('attendance') ? '%' : ''}` : value;
        }

        async function recalculateRisk() {
            if (!currentStudentData) return;
            let simulatedData = { ...currentStudentData };
            simulatedData.AttendancePercentage = parseInt(document.getElementById('attendanceSlider').value);
            simulatedData.AverageScore = parseFloat(document.getElementById('scoreSlider').value);

            try {
                const response = await fetch('/recalculate_risk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(simulatedData)
                });
                if (!response.ok) throw new Error('Recalculation failed');
                const newRisk = await response.json();
                
                const newRiskEl = document.getElementById('newRiskLevel');
                newRiskEl.textContent = newRisk.level;
                const riskColorClasses = { 'High': 'text-red-600', 'Medium': 'text-amber-600', 'Low': 'text-emerald-600' };
                newRiskEl.className = `font-bold text-xl mt-1 transition-all ${riskColorClasses[newRisk.level] || 'text-slate-800'}`;
            } catch (error) {
                console.error("What-If Error:", error);
                document.getElementById('newRiskLevel').textContent = "Error";
            }
        }
        
        async function loadAndRenderNotes(studentID) {
            const notesListEl = document.getElementById('notesList');
            try {
                const response = await fetch(`/get_notes/${studentID}`);
                const notes = await response.json();
                
                if (notes.error) throw new Error(notes.error);

                if (notes.length === 0) {
                    notesListEl.innerHTML = '<p class="text-slate-400 text-sm text-center py-4">No notes logged for this student yet.</p>';
                    return;
                }

                notesListEl.innerHTML = notes.map(note => {
                    const timestamp = new Date(note.timestamp).toLocaleString();
                    return `
                        <div class="text-sm p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <p class="text-slate-700">${note.note_text}</p>
                            <p class="text-xs text-slate-400 mt-2 text-right">${note.mentor_name} on ${timestamp}</p>
                        </div>`;
                }).join('');

            } catch (error) {
                notesListEl.innerHTML = `<p class="text-red-500 text-sm">Could not load notes. ${error.message}</p>`;
            }
        }

        async function addNote() {
            const noteTextEl = document.getElementById('noteText');
            const noteText = noteTextEl.value.trim();
            if (!noteText || !currentStudentData) return;

            try {
                const response = await fetch('/add_note', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        student_id: currentStudentData.StudentID,
                        note_text: noteText,
                        mentor_name: '{{ user_email }}' 
                    })
                });
                const result = await response.json();
                if (result.success) {
                    noteTextEl.value = '';
                    loadAndRenderNotes(currentStudentData.StudentID);
                } else {
                    throw new Error(result.error || 'Failed to add note.');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>

